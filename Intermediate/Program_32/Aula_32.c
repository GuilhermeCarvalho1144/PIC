//CURSO DE PIC
//PROGRAMA 32...ESSE CODIGO IMPLEMENTA UMA LOGICA QUE CONTROLA UM MOTOR DC PELO PWM DO TIMER 2 COM O PIC16F628A
//AS FUNÇÕES RESERVADAS DO MIKROC (VER HELP) SÃO UTILIZADAS PARA INICIAR E SETAR O DUTY CILE...UM ESTRATEGIA DE CONTROLE
//EM MALHA FECHADA TAMBÉM É IMPLEMNETA PARA QUE A CARGA CONSIGA DESENVOLVER A MESMA ROTAÇÃO MESMO COM CARGAS ELEVADAS
//MAIS INFORMÇÕES NO LINK : https://www.youtube.com/watch?v=uv2RLV1FgZc&list=PLZ8dBTV2_5HQ-LrS9r1dP30h8n9sh04gh&index=32
//GUILHERME CARVALHO PEREIRA
//INICIO

//VARIAVEIS
unsigned short duty_per = 70;               //VALOR INCIAL QUE SERÁ O PADRAO PARA O PWM
unsigned feedback;                          //RECEBE O VALOR DA LEITURA DA PORTA ANALOGICA PARA O CONTROLE DO PWM

//FUNÇÃO MAIN
void main() {
     //CONFIGURANDO OS REGITRADORES
     CMCON = 0X07;                          //DESABILITA OS COMPARADORES
     ADCON0 = 0x01;                         //LIGA OS O MODULO A/D
     ADCON1 = 0x0E;                         //DEFINE SOMENTE A PORTA RA0/AN0 COMO ENTRADA ANALOGICA
     //CONFIGURANDO O PWM PELO TIMER 2 COM AS FUNÇÕES RESERVADAS SO MIKROC...VER HELP PARA MAIS INFORMAÇÕES
     PWM1_Init(1000);                       //DEFINE O PWM NA PORTA RC2/CPP1 COM UMA FREQUENCIA DE 1KHz
     PWM1_Set_Duty((duty_per*255)/100);     //SET DUTY CILE DO PWM EM 70%...A FUNÇÃO ACEITA O VALOR EM BITS ESSE É O MOTIVO DA CONTA
     PWM1_Start();                          //INICIA O PWM NA PORTA RC2/CCP1 COM AS CARACTERISTICAS DESCRITAS NAS FUNÇÕES ACIMA
     //LOOP INFINITO
     while(1){
              feedback = ADC_Read(0);                //LE OS VALORES ANALOGICOS EM RA0/AN0
              PWM1_Set_Duty((duty_per*255)/100);     //SET DUTY CILE DO PWM EM 70%...A FUNÇÃO ACEITA O VALOR EM BITS ESSE É O MOTIVO DA CONTA
              if(feedback < 2){
                          duty_per++;                //INCREMNETA O DUTY CICLE DO MOTOR
                          if(duty_per > 90) duty_per = 90;//IMPEDE QUE O RESGITRADOR
              }
              else duty_per = 70;                    //DUTY CICLE PADRAO
     }
}
//FIM